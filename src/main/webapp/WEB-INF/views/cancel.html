<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="https://www.thymeleaf.org"
>
<head>
    <title>Cancel</title>
    <th:block th:include="layout :: headerfiles">
    </th:block>
    <link href="static/assets/styles/css/themes/lite-purple.min.css"
          rel="stylesheet">
    <link href="static/assets/styles/vendor/perfect-scrollbar.css"
          rel="stylesheet">
    <link href="/static/assets/styles/vendor/sweetalert2.min.css"
          rel="stylesheet">
    <style>
        .aln_right {
            text-align: right;
        }

        .table-input {
            max-width: 130px;
            color: black;
            border: none;
            background-color: transparent;
        }
    </style>
</head>
<body class="text-left">
<div th:insert="layout :: preloader"></div>
<div class="app-admin-wrap layout-sidebar-large clearfix">
    <div th:insert="layout :: header"></div>
    <div th:insert="layout :: left-navigation"></div>
</div>

<!-- ============ Body content start ============= -->
<div class="main-content-wrap sidenav-open d-flex flex-column">
    <!-- <div class="breadcrumb">
            <h1>New User</h1>
            <ul>
                <li><a href="">Back</a></li>
                <li>Basic</li>
            </ul>
        </div> -->

    <!--   <div class="separator-breadcrumb border-top"></div> -->

    <div class="row">
        <div class="col-md-1"></div>

        <div class="col-md-10">
            <h4></h4>
            <!-- <p>A form control layout using row with left label alignment.</p> -->
            <div class="card mb-5">
                <div class="card-body">
                    <form method="POST" th:action="@{'/cancel/'+ ${order.id}}"
                          th:object="${order}">
                        <div class="row ">
                            <div class="col-md-4 col-4">
                                <div class="mb-4">
                                    <p class="text-primary mb-1">
                                        <i class="i-Edit-Map text-16 mr-1"></i>Order # :
                                        [[${lab.hospCode}+''
                                        +${#dates.day(order.createdAt)}+${#dates.format(order.createdAt,
                                        'MM')}+${#dates.format(order.createdAt, 'yy')}+'/
                                        '+${#numbers.formatInteger(order.id,8)}]]
                                    </p>
                                </div>
                                <div class="mb-4">
                                    <p class="text-primary mb-1">
                                        <i class="i-MaleFemale text-16 mr-1"></i> Patient: <span
                                            style="text-transform: capitalize;">[[${order.patient.title}+'
												'+${order.patient.firstName}+' '+${order.patient.lastName}]]</span>
                                    </p>

                                </div>


                            </div>
                            <div class="col-md-4 col-4">
                                <div class="mb-4">
                                    <p class="text-primary mb-1">
                                        <i class="i-Calendar text-16 mr-1"></i> Order Date:
                                        [[${#dates.format(order.createdAt , 'dd-MMM-yyyy hh:mm a')}]]
                                    </p>
                                </div>
                                <div class="mb-4">
                                    <p class="text-primary mb-1">
                                        <i class="i-MaleFemale text-16 mr-1"></i> Gender / Age: <span>[[${order.patient.gender}]]</span>
                                        / <span id="age"></span>
                                    </p>


                                </div>


                            </div>
                            <div class="col-md-4 col-6">

                                <div class="mb-4">
                                    <p class="text-primary mb-1">
                                        <i class="i-Professor text-16 mr-1"></i> Ordered By: <span>[[${order.updatedBy.ssoId}]]</span>
                                    </p>

                                </div>
                                <div class="mb-4">
                                    <p>&nbsp;</p>
                                </div>

                            </div>
                        </div>
                        <div class="row">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Service</th>
                                        <!-- <th>Qty.</th> -->
                                        <th style="text-align: right;" th:if="${billing}">Price</th>
                                        <th style="text-align: right;"><span th:if="${billing}">Discount</span></th>
                                        <th style="text-align: right;">Cancel</th>
                                        <!-- <th scope="col">Action</th> -->
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="orderDetail,od:${order.orderDetails}"
                                        th:if="${!billing}">
                                        <th scope="row">[[${od.count}]]</th>
                                        <td>[[${orderDetail.investigation.invest_name}]]<span
                                                style="color: red"
                                                th:text="${orderDetail.packageId}?'  *Package':''"></span></td>
                                        <!-- <td>1</td> -->

                                        <td align="right" th:if="${billing}"><input name="rid" th:value="${orderDetail.id}"
                                                                                    type="hidden"> <input
                                                name="tid"
                                                th:value="${orderDetail.investigation.id}" type="hidden">
                                            <input name="testName" th:value="${orderDetail.investigation.invest_name}"
                                                   type="hidden">
                                            [[${orderDetail.testRate}]]
                                        </td>
                                        <td></td>
                                        <td class="d-flex flex-row-reverse">
                                            <th:block
                                                    th:if="${#strings.equalsIgnoreCase('ORDERED', orderDetail.status)} or ${#strings.equalsIgnoreCase('SAMPLE_COLLECTED', orderDetail.status)} or ${#strings.equalsIgnoreCase('RE_RUN_SAMPLE', orderDetail.status)} or ${#strings.equalsIgnoreCase('VERIFIED', orderDetail.status)}">
                                                <div class="text-danger mr-2">
                                                    <i class="nav-icon i-Close-Window font-weight-bold "></i>
                                                </div>
                                                <div>
                                                    <input name="cancel" onchange="setPackage(this)"
                                                           th:attr="data-package=${orderDetail.packageId}"
                                                           th:value="${orderDetail.id}"
                                                           type="checkbox">
                                                </div>
                                            </th:block>
                                            <th:block
                                                    th:if="${#strings.equalsIgnoreCase('RESULT_SAVED', orderDetail.status)} or ${#strings.equalsIgnoreCase('AUTHORIZED', orderDetail.status)} or ${#strings.equalsIgnoreCase('PRINTED', orderDetail.status)} or ${#strings.equalsIgnoreCase('SAMPLE_REJECTED', orderDetail.status)} or ${#strings.equalsIgnoreCase('CANCELED', orderDetail.status)}">

                                                <div> [[${orderDetail.status}]]</div>
                                            </th:block>
                                        </td>
                                        <!-- <td class="d-flex flex-row-reverse"><th:block
                                                th:if="${!#strings.equalsIgnoreCase('CANCELED', orderDetail.status)} and ${!#strings.equalsIgnoreCase('1', orderDetail.machineStatus)}">
                                                <div class="text-danger mr-2">
                                                    <i class="nav-icon i-Close-Window font-weight-bold "></i>
                                                </div>
                                                <div>
                                                    <input type="checkbox" name="cancel"
                                                        onchange="setPackage(this)"
                                                        th:attr="data-package=${orderDetail.packageId}"
                                                        th:value="${orderDetail.id}">
                                                </div>
                                            </th:block> <th:block
                                                th:unless="${!#strings.equalsIgnoreCase('CANCELED', orderDetail.status)} and ${!#strings.equalsIgnoreCase('1', orderDetail.machineStatus)}">
                                                <div class="text-danger mr-2">
                                                    <i class="nav-icon i-Close-Window font-weight-bold "></i>
                                                </div>
                                                <div>[[${#strings.equalsIgnoreCase('CANCELED',
                                                    orderDetail.status)} ?'CANCELED' :'MACHINE' ]]</div>
                                            </th:block></td> -->
                                    </tr>
                                    <th:block th:if="${billing}">
                                        <tr th:each="orderDetail,od:${order.invoice.invoiceDetails}">
                                            <th scope="row">[[${od.count}]]</th>
                                            <td>[[${orderDetail.testName}]]</td>
                                            <td>1</td>

                                            <td align="right"><input name="rid" th:value="${orderDetail.id}"
                                                                     type="hidden"> <input
                                                    name="tid" th:value="${orderDetail.investigationMasterId}"
                                                    type="hidden">
                                                <input name="testName" th:value="${orderDetail.testName}"
                                                       type="hidden">

                                                [[${orderDetail.totalAmount}]]
                                            </td>
                                            <td style="text-align: right;">[[${orderDetail.discount}]]</td>
                                            <td class="d-flex flex-row-reverse">
                                                <th:block
                                                        th:if="${!#strings.equalsIgnoreCase('REFUND', orderDetail.status)}">
                                                    <div class="text-danger mr-2">
                                                        <i class="nav-icon i-Close-Window font-weight-bold "></i>
                                                    </div>
                                                    <div>
                                                        <input name="cancel" th:value="${orderDetail.id}"
                                                               type="checkbox">
                                                    </div>
                                                </th:block>
                                                <th:block
                                                        th:unless="${!#strings.equalsIgnoreCase('REFUND', orderDetail.status)}">
                                                    <div class="text-danger mr-2">
                                                        <i class="nav-icon i-Close-Window font-weight-bold "></i>
                                                    </div>
                                                    <div>CANCELED</div>
                                                </th:block>
                                            </td>
                                        </tr>
                                    </th:block>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="row" th:if="${billing}">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                    <tr>
                                        <th></th>
                                        <th></th>
                                        <thaln_right
                                        ">Total:</th>
                                        <th aln_right
                                        " >
                                        [[${order.invoice.totalAmount}]]
                                        </th>
                                        <th class="aln_right">
                                            [[${order.invoice.discount}]]
                                        </th>
                                        <th class="col-md-2" style="text-align:right;"></th>
                                        <!-- <th scope="col">Action</th> -->
                                    </tr>
                                    </thead>
                                </table>
                            </div>

                        </div>
                </div>
                <div class="row">
                    <div class="col-sm-5"></div>
                    <div class="col-sm-3 aln_right"></div>
                    <div class="col-sm-1 aln_right"></div>
                    <div class="col-sm-1"></div>
                    <div class="col-sm-2 aln_right">
                        <button class="btn btn-primary" type="submit">Submit</button>

                    </div>
                </div>

                </form>
            </div>
        </div>
    </div>
</div>


</div>

<div th:insert="layout :: search-ui"></div>
<footer th:insert="layout :: footer"></footer>

<script th:src="@{/static/assets/js/vendor/sweetalert2.min.js}"></script>
<script th:src="@{/static/assets/js/sweetalert.script.js}"></script>

</body>
<script>
    $(document).ready(function(){

        var dob = /*[[${order.patient.birthday}]]*/ '1970';


          var today = new Date();
        var birthday = new Date(dob);

        var differenceInMilisecond = today.valueOf() - birthday.valueOf();

        var year_age = Math.floor(differenceInMilisecond / 31536000000);
        var day_age = Math.floor((differenceInMilisecond % 31536000000) / 86400000);


        var month_age = Math.floor(day_age/30);

        day_age = day_age % 30;

        if (isNaN(year_age) || isNaN(month_age) || isNaN(day_age)) {
            //alert("Invalid birthday - Please try again!");
        }
        else {
            if(year_age != 0){
                $("#age").html(year_age+" Years ");
                    }else if( month_age != 0){
                       $("#age").html(month_age+" Month's ");
                    }else{
                $("#age").html(day_age+" Days ");
                    }
          // alert("You are<br/><span id=\"age\">" + year_age + " years " + month_age + " months " + day_age + " days</span> old");
        }
    });

    function setDiscount(elm){
        var sum =0.0;
        var rate=document.getElementsByName("rate");
        var disc=document.getElementsByName("disc");
        for(var i=0; i<disc.length; i++){
            disc[i].value=rate[i].value*elm.value/100;
            sum+=parseFloat(disc[i].value);
        }
        document.getElementById("totalDiscount").value=sum;
        document.getElementById("pay").value=parseFloat(document.getElementById("total").value)  - sum;
    }
    function updateDiscount(elm){
        var valid = parseFloat(elm.value.match(/^-?\d*(\.\d+)?$/));

        if(valid==null || isNaN(valid)){
            swal({
                type: 'warning',
                title: 'Warning!',
                text: 'Please enter valid discount in number',
                buttonsStyling: false,
                confirmButtonClass: 'btn btn-lg btn-warning'
            });
            elm.value=0;
        }

        var sum =0.0;
        var disc=document.getElementsByName("disc");
        var auth_discount = parseFloat(elm.getAttribute('data-rate'))*parseFloat($("#discount").val())/100;
        if(parseFloat(elm.value)>auth_discount){
            elm.value=0;
        }
        for(var i=0; i<disc.length; i++){
            sum+=parseFloat(disc[i].value);
        }
        document.getElementById("totalDiscount").value=sum;
        document.getElementById("pay").value=parseFloat(document.getElementById("total").value) - sum;
    }
    function setPackage(checkbox){
        var pack = checkbox.getAttribute("data-package");
        if(pack!=null){
            var stat = checkbox.checked;
            var x = document.getElementsByName("cancel");
            for(var i=0; i<x.length; i++){
                if(x[i].getAttribute("data-package")==pack){
                    x[i].checked=stat;
                }

            }
        }

    }

</script>

</html>