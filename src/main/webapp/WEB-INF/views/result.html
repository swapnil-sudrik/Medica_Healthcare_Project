<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity3"
      xmlns:th="https://www.thymeleaf.org">
<style>
    .ORDERED{background-color: olivedrab; color:yellow;}
    .SAMPLE_COLLECTED{background-color: red; color:white;}
    .RESULT_SAVED{background-color: #e0c911; color:blue;}
    .AUTHORIZED{color: green;}
    .ABNORMAL{border-color: red;}
    .PRINTED{background-color: green; color:yellow;}
    .SAMPLE_REJECTED{background-color: #8a2142; color:white;}
    .CANCELED{background-color: red; color:white;}
    .VERIFIED{background-color: #fcf403;}
    .hideContent{display:none;}
    .RE_RUN_SAMPLE {
	background-color: #bafc03;
	color: black;
}
</style>
<head>
    <title>Patient Work Sheet</title>
    <th:block th:include="layout :: headerfiles">
    </th:block>
    <link href="static/assets/styles/css/themes/lite-purple.min.css"
          rel="stylesheet">
    <link href="static/assets/styles/vendor/perfect-scrollbar.css"
          rel="stylesheet">
    <link href="static/assets/styles/vendor/pickadate/classic.css"
          rel="stylesheet">
    <link href="static/assets/styles/vendor/pickadate/classic.date.css"
          rel="stylesheet">
</head>
<body class="text-left">

<div th:insert="layout :: preloader"></div>
<div class="app-admin-wrap layout-sidebar-large clearfix">
    <div th:insert="layout :: header"></div>
    <div th:insert="layout :: left-navigation"></div>
</div>
<!-- ============ Body content start ============= -->
<div class="main-content-wrap sidenav-open d-flex flex-column">
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card" style="position: sticky; top: 100px; z-index: 2;">
                <!-- <img class="d-block w-100" src="assets/images/products/iphone-1.jpg" alt="First slide"> -->


                <div class="card-body">
                    <div class="ul-contact-detail__info">
                        <div class="row">
                            <div class="col-12 text-center">
                                <div class="ul-contact-detail__info-1">
                                    <h4 style="color:#663399">[[${#strings.capitalizeWords(order.patient.firstName)}+'
                                        '+${#strings.capitalizeWords(order.patient.lastName)}]] </h4>
                                    <span>[[${order.patient.relationWithPatient}+' '+${#strings.capitalizeWords(order.patient.relativeName)}]]</span>
                                </div>
                            </div>
                            <div class="col-6 text-center">
                                <div class="ul-contact-detail__info-1">
                                    <h5>Gender</h5>
                                    <span>[[${order.patient.gender}]]</span>
                                </div>
                                <div class="ul-contact-detail__info-1">
                                    <h5>Order No.</h5>
                                    <span>[[${lab.hospCode}+'' +${#dates.day(order.createdAt)}+${#dates.format(order.createdAt, 'MM')}+${#dates.format(order.createdAt, 'yy')}+'/ '+${#numbers.formatInteger(order.id,8)}]]</span>
                                </div>
                                <div class="ul-contact-detail__info-1">
                                    <h5>Referred By:</h5>
                                    <span>[[${#strings.capitalizeWords(order.ReferredBy)}]]</span>
                                </div>
                                <div class="ul-contact-detail__info-1" th:if="${order.otherTag}!=''">
                                    <h5>Center:</h5>
                                    <span>[[${order.otherTag}]]</span>
                                </div>
                            </div>
                            <div class="col-6 text-center">
                                <div class="ul-contact-detail__info-1">
                                    <h5>Age</h5>
                                    <span th:with="y1=((${order.patient.birthday}!='NaN/undefined/NaN') and (${order.patient.birthday}!='') and ${order.patient.birthday})?${#dates.year(#dates.createNow())}:'0000', y2=((${order.patient.birthday}!='NaN/undefined/NaN') and (${order.patient.birthday}!='') and ${order.patient.birthday})?${#dates.year(order.patient.birthday)}:'0000'">
							</span><span id="age"></span>
                                </div>
                                <div class="ul-contact-detail__info-1">
                                    <h5>Visit Type</h5>
                                    <span>[[${order.facility}]]</span>
                                </div>


                                <div class="ul-contact-detail__info-1">
                                    <h5>OPD/IPD/ANC #:</h5>
                                    <span>[[${order.facilityNumber}]]</span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="col-md-9 mb-4">
            <div class="card text-left">


                <div class="card-body">


                    <form id="formResultSave" method="post" th:action="@{'/result/'+${order.id}+'/'+${work_list}}"
                          th:object="${order}">
                        <div class="col-md-12 mb-4">
							<span>
							<a class="btn btn-primary"
                               th:href="${work_list} ? @{'/worklist'} :@{'/other-worklist'}"><span class="ul-btn__text">Back</span></a></span>

                            <a class="btn  btn-sm btn-rounded btn-icon m-1"
                               sec:authorize="hasRole('Technician') or hasRole('Lab_Admin') "
                               style="background-color: #8a2142; color:white;"
                               th:href="@{'/sampleReject/'+ ${order.id}+'/'+${work_list}}">
                                <span class="ul-btn__icon"><i class="i-Atom"></i></span>
                                <span class="ul-btn__text"><b>Sample Reject</b></span>

                            </a>
                            <button class="btn btn-success save" style="margin:0 0 5px 0; float:right" type="button">
                                Save
                            </button>
                            <div>
                                <div class="table-responsive">
                                    <table class="table" id="table_id">

                                        <th:block th:each="orderDeatil,oStat : ${order.orderDetails}">

                                            <thead>
                                            <tr>

                                                <th colspan="4" scope="col" style="text-align:left;"><h5
                                                        style="color:#663399">[[${oStat.index+1}+'.
                                                    '+${#strings.abbreviate(orderDeatil.investigation.invest_name,40)} +
                                                    ' - ' + ${orderDeatil.barcode}]]</h5></th>
                                                <th scope="col"><span class="badge  r-badge"
                                                                      th:classappend="${orderDeatil.status}">[[${orderDeatil.status}]]</span>
                                                    <span style="color:green;"
                                                          th:if="${!#strings.isEmpty(orderDeatil.authorizedById)}">
                                            <i class="nav-icon i-Pen-2 font-weight-bold"></i>
                                            by_[[${orderDeatil.authorizedById}]]</span>
                                                </th>
                                            </tr>
                                            <tr>
                                                <th colspan="2"
                                                    style="display:none;" th:if="!${#strings.equalsIgnoreCase(orderDeatil.status,'Authorized')}">
                                                    <th:block
                                                            sec:authorize="hasRole('Pathologist') or hasRole('Lab_Admin') or hasRole('Technician')"
                                                            th:if="!${#strings.equalsIgnoreCase(orderDeatil.status,'PRINTED')}">
                                                        <span>Re-run Sample</span>
                                                        <input name="isRerunSample"
                                                               th:checked="${#strings.isEmpty(orderDeatil.sampleRerunFlag)}" th:if="${!#strings.equalsIgnoreCase(orderDeatil.status,'SAMPLE_REJECTED')}"
                                                               th:value="${orderDeatil.id}"
                                                               type="checkbox">

                                                    </th:block>

                                                </th>
                                                <th colspan="2">
                                                    <th:block
                                                            sec:authorize="hasRole('Pathologist') or hasRole('Lab_Admin') ">
                                                        <span>Pathologist Authorization</span>
                                                        <input th:field="*{orderDetails[__${oStat.index}__].id}"
                                                               type="hidden">
                                                        <input name="isAuthorized"
                                                               th:checked="${!#strings.isEmpty(orderDeatil.authorizedById)}" th:if="${!#strings.equalsIgnoreCase(orderDeatil.status,'SAMPLE_REJECTED')}"
                                                               th:value="${orderDeatil.id}"
                                                               type="checkbox">
                                                        <!-- <a href="#" class="text-success mr-2">

                                                        </a> -->
                                                    </th:block>
                                                    <th:block
                                                            sec:authorize="!hasRole('Pathologist') or !hasRole('Lab_Admin') "
                                                            style="display:none;"
                                                            th:else="${!#strings.equalsIgnoreCase(orderDeatil.status,'SAMPLE_REJECTED')}">
                                                        <span></span>
                                                        <input th:field="*{orderDetails[__${oStat.index}__].id}"
                                                               type="hidden">

                                                        <!-- <a href="#" class="text-success mr-2">

                                                        </a> -->
                                                    </th:block>
                                                </th>
                                                <th colspan="2">
                                                    <th:block
                                                            sec:authorize="hasRole('Technician') or hasRole('Lab_Admin') ">
                                                        <span>Technician Verification</span>
                                                        <input th:field="*{orderDetails[__${oStat.index}__].id}"
                                                               type="hidden">
                                                        <input name="isTechVerified"
                                                               th:checked="${!#strings.equalsIgnoreCase(orderDeatil.techVerifiedById,'0')}" th:if="${!#strings.equalsIgnoreCase(orderDeatil.status,'SAMPLE_REJECTED')}"
                                                               th:value="${orderDeatil.id}"
                                                               type="checkbox">

                                                    </th:block>
                                                    <th:block
                                                            sec:authorize="!hasRole('Technician') or !hasRole('Lab_Admin') "
                                                            style="display:none;"
                                                            th:else="${!#strings.equalsIgnoreCase(orderDeatil.status,'SAMPLE_REJECTED')}">
                                                        <span></span>
                                                        <input th:field="*{orderDetails[__${oStat.index}__].id}"
                                                               type="hidden">


                                                    </th:block>
                                                </th>

                                            </tr>

                                            <tr style="font-size:8px; display:none;">
                                                <td align="right" colspan="6">
                                                    <input th:checked="${(orderDeatil.corelationWithDiagnosis) == 'Y'}" th:field="*{orderDetails[__${oStat.index}__].corelationWithDiagnosis}"
                                                           th:value="Y"
                                                           type="checkbox">&nbsp;<span
                                                        style="font-size:9px; ">Co-relation with diagnosis</span>&nbsp;&nbsp;
                                                    <input th:checked="${(orderDeatil.reportingError) == 'Y'}" th:field="*{orderDetails[__${oStat.index}__].reportingError}"
                                                           th:value="Y"
                                                           type="checkbox">&nbsp;REPORTING
                                                    ERROR&nbsp;&nbsp;
                                                    <input th:checked="${(orderDeatil.toConfirmFindings) == 'Y'}" th:field="*{orderDetails[__${oStat.index}__].toConfirmFindings}"
                                                           th:value="Y"
                                                           type="checkbox">&nbsp;TO
                                                    CONFIRM FINDING&nbsp;&nbsp;
                                                    <input th:checked="${(orderDeatil.deviceError) == 'Y'}" th:field="*{orderDetails[__${oStat.index}__].deviceError}"
                                                           th:value="Y"
                                                           type="checkbox">&nbsp;DEVICE
                                                    ERROR&nbsp;&nbsp;
                                                    <input th:checked="${(orderDeatil.technicianOrOperatorError) == 'Y'}" th:field="*{orderDetails[__${oStat.index}__].technicianOrOperatorError}"
                                                           th:value="Y"
                                                           type="checkbox">&nbsp;TECHNICIAN/
                                                    OPERATOR ERROR&nbsp;&nbsp;
                                                <td>
                                            </tr>
                                            <tr>

                                                <th scope="col">#</th>
                                                <th colspan="2" scope="col">Parameter</th>
                                                <th scope="col" style="text-align:left">Result</th>

                                                <th scope="col">Normal Range</th>
                                                <th scope="col"> Updated By</th>
                                            </tr>
                                            </thead>
                                            <tbody th:if="${!#strings.equalsIgnoreCase(orderDeatil.status,'Ordered')}
                                    			and ${!#strings.equalsIgnoreCase(orderDeatil.status,'SAMPLE_REJECTED')}
                                    			and ${!#strings.equalsIgnoreCase(orderDeatil.investigation.section,'MICROBIOLOGY')}">
                                            <tr th:class="(${lisResult.heading} == 1)?'hideContent':''"
                                                th:each="lisResult,iStat : ${orderDeatil.lisResults}">

                                                <th scope="row">[[${iStat.index+1}]]</th>
                                                <td colspan="2" style="font-weight: bold;"
                                                    th:classappend="${#strings.equalsIgnoreCase(orderDeatil.status,'Authorized')?'AUTHORIZED':''}">
                                                    [[${lisResult.testName}]]
                                                </td>
                                                <td th:colspan="!${#strings.equalsIgnoreCase(lisResult.test_code,'3695')}?1:2">
                                                    <input th:field="*{orderDetails[__${oStat.index}__].lisResults[__${iStat.index}__].id}"
                                                           type="hidden">
                                                    <!-- If normal input text  -->
                                                    <input class="form-control"
                                                           onkeyup="calculatevalues();"
                                                           style="text-transform:none;"
                                                           th:classappend="${lisResult.isAbnormalResult and !#strings.isEmpty(lisResult.result)}?'ABNORMAL':''"
                                                           th:field="*{orderDetails[__${oStat.index}__].lisResults[__${iStat.index}__].result}"
                                                           th:id="${lisResult.loinc_code}" th:if="!${#strings.equalsIgnoreCase(lisResult.test_code,'3695')}
                                                 				and !${lisResult.isSelectable}"
                                                           th:readonly="${#strings.equalsIgnoreCase(orderDeatil.status,'Authorized')} or
                                                 ${#strings.equalsIgnoreCase(orderDeatil.status,'PRINTED')} or
                                                 ${#strings.equalsIgnoreCase(orderDeatil.status,'SAMPLE_REJECTED')}"
                                                           type="text">
                                                    <!--END If normal input text  -->

                                                    <!-- If select input text i.e. isSelectable is 1 in lis result  -->

                                                    <select class="form-control" th:classappend="${lisResult.isAbnormalResult and !#strings.isEmpty(lisResult.result)}?'ABNORMAL':''"
                                                            th:disabled="${#strings.equalsIgnoreCase(orderDeatil.status,'Authorized')} or
                                                  ${#strings.equalsIgnoreCase(orderDeatil.status,'PRINTED')} or
                                                   ${#strings.equalsIgnoreCase(orderDeatil.status,'SAMPLE_REJECTED')}"
                                                            th:field="*{orderDetails[__${oStat.index}__].lisResults[__${iStat.index}__].result}"
                                                            th:id="${lisResult.loinc_code}"
                                                            th:if="${lisResult.isSelectable}">
                                                        <option value="">Select</option>
                                                        <option th:each="option,i :${#strings.listSplit(lisResult.selectOptions,',')}"
                                                                th:value="${option}">
                                                            [[${option}]]
                                                        </option>

                                                    </select>

                                                    <!--END If select input text i.e. isSelectable is 1 in lis result  -->
                                                    <textarea cols="50" rows="4"
                                                              th:classappend="${lisResult.isAbnormalResult and !#strings.isEmpty(lisResult.result)}?'ABNORMAL':''"

                                                              th:disabled="${#strings.equalsIgnoreCase(orderDeatil.status,'Authorized')} or ${#strings.equalsIgnoreCase(orderDeatil.status,'PRINTED')} or ${#strings.equalsIgnoreCase(orderDeatil.status,'SAMPLE_REJECTED')}"
                                                              th:field="*{orderDetails[__${oStat.index}__].lisResults[__${iStat.index}__].result}"
                                                              th:id="${lisResult.loinc_code}"
                                                              th:if="${#strings.equalsIgnoreCase(lisResult.test_code,'3695')}"> </textarea>
                                                </td>

                                                <td style="text-transform: none;"
                                                    th:if="!${#strings.equalsIgnoreCase(lisResult.test_code,'3695')}"><span
                                                        th:if="${lisResult.minRange}!=null or ${lisResult.maxRange}!=null">[[${lisResult.minRange}+' - '+${lisResult.maxRange}+' '+${lisResult.unit}]]</span>
                                                </td>


                                                <td>[[${lisResult.updatedByUsername}]]
                                                </td>
                                            </tr>

                                            <tr class="rowitem">
                                                <th>Note:</th>
                                                <td class="td_div" colspan="4">
                                                    <div th:each="notes : (${#lists.size(orderDeatil.lisResults)}==0) ? '' :${#strings.arraySplit( orderDeatil.lisResults[0].notes, '~')}">
                                                        [[${notes}]]
                                                    </div>
                                                </td>
                                                <!-- <img src="${pageContext.request.contextPath }/barcode/${orderDeatil.barcode}" width="200" height="50"> -->
                                            </tr>

                                            </tbody>
                                        </th:block>
                                    </table>
                                </div>
                                <div align="right" class="col-md-12 mb-4">
                                    <button class="btn btn-success save" type="submit">Save</button>
                                    <div>
                    </form>

                </div>
            </div>
        </div>
    </div>
    <!-- <div >
    <table>
     <tr><td>State</td><td>Districts</td></tr>
     <th:block th:each="investigation : ${map}">
       <tr>
         <td th:text="${investigation.key}">State</td>
              <th:block th:each="parameter : ${investigation.value}">
        <td th:text="${parameter}">District</td>
              </th:block>
       </tr>
     </th:block>
         </table>
    </div> -->

    <!-- end of row -->


    <div th:insert="layout :: search-ui"></div>
    <footer th:insert="layout :: footer"></footer>
</body>
</html>
<script th:inline="javascript">
    $(document).ready(function(){

        var dob = /*[[${order.patient.birthday}]]*/ '1970';


          var today = new Date();
        var birthday = new Date(dob);

        var differenceInMilisecond = today.valueOf() - birthday.valueOf();

        var year_age = Math.floor(differenceInMilisecond / 31536000000);
        var day_age = Math.floor((differenceInMilisecond % 31536000000) / 86400000);


        var month_age = Math.floor(day_age/30);

        day_age = day_age % 30;

        if (isNaN(year_age) || isNaN(month_age) || isNaN(day_age)) {
            //alert("Invalid birthday - Please try again!");
        }
        else {
            if(year_age != 0){
                $("#age").html(year_age+" Years ");
                    }else if( month_age != 0){
                       $("#age").html(month_age+" Month's ");
                    }else{
                $("#age").html(day_age+" Days ");
                    }
          // alert("You are<br/><span id=\"age\">" + year_age + " years " + month_age + " months " + day_age + " days</span> old");
        }

        /* Note's empty value should hide */

        $('.td_div').each(function(index, value) {
              //console.log(index, $.trim($(this).text()));
              if($.trim($(this).text()) == '')
                  {
                     //console.log('empty');
                     //console.log($(".rowitem")[index]);
                     $(".rowitem").eq(index).hide();
                  }else {
                      //console.log('value');
                      $('.rowitem').eq(index).show();
                  }

            });

    });

        function valueChanged()
        {
            if($('.nabl_question').is(":checked"))
                $(".HideOrShow").show();
            else
                $(".HideOrShow").hide();
        }
        function calculatevalues() {
            //Deepshikha rajput
            //Lipid Profile
            var v1 = document.getElementById("1001");
            if (v1) {
                var v11 = v1.value;
            } else {
                var v11 = 0;
            }
            var v2 = document.getElementById("1002");
            if (v2) {
                var v21 = v2.value;
            } else {
                var v21 = 0;
            }
            var v3 = document.getElementById("1003");
            if (v3) {
                var v31 = v3.value;
            } else {
                var v31 = 0;
            }
            var ldl = Number(v11)-Number(v31) - Number((v21/5));
            var vldl = Number((v21/5));
            var ch=  Number(v11)/Number(v31);
            var lh = Number(ldl.toFixed(2))/Number(v31);
            $('#1004').val(ldl.toFixed(2));
            $('#1005').val(vldl.toFixed(2));
            $('#1006').val(ch.toFixed(2));
            $('#1007').val(lh.toFixed(2));
          //Liver function test
          //Total bilirubin- direct bilirubin= indirect bilirubin
          //Total protein - albumin = globulin
          //Albumin/ globulin= a/g ratio
           var v4 = document.getElementById("2001");
            if (v4) {
                var v41 = v4.value;
            } else {
                var v41 = 0;
            }
            var v5 = document.getElementById("2002");
            if (v5) {
                var v51 = v5.value;
            } else {
                var v51 = 0;
            }
            var v6 = document.getElementById("2006");
            if (v6) {
                var v61 = v6.value;
            } else {
                var v61 = 0;
            }
            var v7 = document.getElementById("2007");
            if (v7) {
                var v71 = v7.value;
            } else {
                var v71 = 0;
            }
            var ib = Number(v41) - Number(v51);
            var gbl = Number(v61) -  Number(v71);
            var ag = Number(v71) /gbl.toFixed(2);
            $('#2010').val(ib.toFixed(2));
            $('#2008').val(gbl.toFixed(2));
            $('#2009').val(ag.toFixed(2));
            //cbc
         // T & D
            var v24 = document.getElementById("4042");
    if(v24){
     var v241 = v24.value;
    }else{
       var v241= 0;
    }
      var v25 = document.getElementById("4043");
    if(v25){
     var v251 = v25.value;
    }else{
       var v251= 0;
    }
      var v26 = document.getElementById("4044");
    if(v26){
     var v261 = v26.value;
    }else{
       var v261= 0;
    }
      var v27 = document.getElementById("4045");
    if(v27){
     var v271 = v27.value;
    }else{
       var v271= 0;
    }
      var v28 = document.getElementById("4046");
    if(v28){
     var v281 = v28.value;
    }else{
       var v281= 0;
    }
      var v29 = document.getElementById("4047");
    if(v29){
     var v291 = v29.value;
    }else{
       var v291= 0;
    }
    // alert(v241 + ' ~' + v251+ ' ~' + v261+ ' ~' + v271+ ' ~' + v281+ ' ~' + v291 );
    var total_tandd = Number(v241) + Number(v251) + Number(v261) +Number(v271) +Number(v281) +Number(v291 );
    var total_tandd1 = total_tandd.toFixed(2);
    if(total_tandd1 > 100){
         alert ('Sum of Neutrophils, Lymphocytes, Eosinophil,Monocyte, Band Form and Basophils must be equal to 100 and value of individual cannot be zero');

     }

        }
        window.onload = calculatevalues;

        $('.save').on('click', function() {
            $('select').prop('disabled',false);
            $('textarea').prop('disabled',false);
            $('#formResultSave').submit();
        });

</script>
<script th:src="@{/static/assets/js/psForComment.script.js}" type="text/javascript"></script>